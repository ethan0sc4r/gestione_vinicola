<!-- barcode_scanner.html -->
{% extends "base.html" %}

{% block title %}Scanner - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .scanner-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 120px);
    }
    
    .scanner-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        border: 2px dashed var(--primary-color);
        border-radius: 20px;
        background-color: rgba(0, 122, 255, 0.05);
        margin-bottom: 1.5rem;
        padding: 2rem;
        position: relative;
    }
    
    .scanner-icon {
        font-size: 4rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }
    
    .scanner-pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .scanner-status {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-connected {
        background-color: rgba(52, 199, 89, 0.2);
        color: var(--success-color);
    }
    
    .status-disconnected {
        background-color: rgba(255, 59, 48, 0.2);
        color: var(--danger-color);
    }
    
    .status-waiting {
        background-color: rgba(255, 204, 0, 0.2);
        color: var(--warning-color);
    }
    
    .last-scan {
        background-color: white;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        margin-top: 1rem;
        border: 1px solid rgba(0, 0, 0, 0.1);
        font-family: monospace;
        font-size: 1.2rem;
    }
    
    .manual-input {
        width: 100%;
        max-width: 500px;
        margin: 0 auto 1.5rem;
    }
    
    /* Stili per la scheda dipendente */
    .employee-card {
        display: none; /* Nascosto di default */
        background: linear-gradient(to right, var(--primary-color), #0062cc);
        color: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .employee-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .employee-info {
        display: flex;
        align-items: center;
    }
    
    .employee-avatar {
        width: 60px;
        height: 60px;
        background-color: white;
        color: var(--primary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
        margin-right: 1rem;
    }
    
    .employee-name {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .employee-rank {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .employee-credit {
        text-align: right;
    }
    
    .credit-amount {
        font-size: 1.8rem;
        font-weight: 700;
    }
    
    .credit-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .credit-limit {
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }
    
    /* Stili per la selezione prodotti */
    .product-selection {
        display: none; /* Nascosto di default */
        background-color: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .product-item {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .product-item:hover {
        background-color: #e9ecef;
        transform: translateY(-2px);
    }
    
    .product-item.selected {
        background-color: rgba(0, 122, 255, 0.1);
        border-color: var(--primary-color);
    }
    
    .product-name {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .product-price {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .custom-amount-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
    }
    
    /* Stili per la conferma */
    .confirmation {
        display: none; /* Nascosto di default */
        text-align: center;
        padding: 2rem;
        background-color: white;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .confirmation-icon {
        font-size: 4rem;
        color: var(--success-color);
        margin-bottom: 1rem;
    }
    
    .confirmation-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .confirmation-message {
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
    }
    
    .confirmation-details {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        text-align: left;
    }
    
    .confirmation-detail {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .confirmation-label {
        font-weight: 500;
        color: #6c757d;
    }
    
    .confirmation-value {
        font-weight: 600;
    }
    
    /* Stili per il form di ricarica credito */
    .credit-form {
        display: none; /* Nascosto di default */
        background-color: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .credit-presets {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .credit-preset {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 0.75rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .credit-preset:hover {
        background-color: #e9ecef;
        transform: translateY(-2px);
    }
    
    .credit-preset.selected {
        background-color: rgba(52, 199, 89, 0.1);
        border-color: var(--success-color);
    }
    
    .admin-link {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 20px;
        color: #6c757d;
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .admin-link:hover {
        background-color: rgba(0, 0, 0, 0.2);
        color: #212529;
    }
    
    /* Stili per la tabella dipendenti in stile admin */
    .employees-table-container {
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        width: 100%;
        margin-bottom: 1.5rem;
    }
    
    .table-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .table-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }
    
    .table-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .table-search {
        width: 300px;
    }
    
    .table-wrapper {
        padding: 1rem 1.5rem;
        overflow-x: auto;
    }
    
    .employees-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .employees-table th {
        padding: 0.75rem;
        font-weight: 600;
        border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        text-align: left;
        color: #6c757d;
    }
    
    .employees-table td {
        padding: 0.75rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        vertical-align: middle;
    }
    
    .employees-table tr:last-child td {
        border-bottom: none;
    }
    
    .employees-table tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .employee-avatar {
        width: 40px;
        height: 40px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 0.75rem;
    }
    
    .employee-name-cell {
        display: flex;
        align-items: center;
    }
    
    .employee-info {
        display: flex;
        flex-direction: column;
    }
    
    .employee-name {
        font-weight: 500;
    }
    
    .employee-rank {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .employee-code {
        font-family: monospace;
        background-color: #f8f9fa;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }
    
    .employee-credit {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .table-actions {
        display: flex;
        gap: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Toggle Interface Button -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
        <i class="fas fa-barcode me-2"></i>
        Scanner Codici
    </h2>
    <div class="btn-group">
        <form method="POST" action="{{ url_for('toggle_interface') }}" style="display: inline;">
            <input type="hidden" name="interface_type" value="products_first">
            <button type="submit" class="btn btn-outline-success">
                <i class="fas fa-shopping-cart me-1"></i>
                Prodotti Prima
            </button>
        </form>
        <button type="button" class="btn btn-outline-info" onclick="showInventoryReport()">
            <i class="fas fa-boxes me-1"></i>
            Giacenze
        </button>
        <button type="button" class="btn btn-outline-warning" onclick="showRecentTransactions()">
            <i class="fas fa-history me-1"></i>
            Transazioni
        </button>
    </div>
</div>

<div class="scanner-container">
    <!-- Scanner Area -->
    <div class="scanner-area" id="scannerArea">
        <span class="scanner-status status-waiting" id="scannerStatus">
            <i class="fas fa-circle me-1"></i> In attesa di connessione...
        </span>
        
        <div class="mb-3">
            {% if last_barcode %}
            <div class="last-scan mb-3">
                <span id="lastBarcode">{{ last_barcode }}</span>
                <button class="btn btn-sm btn-outline-primary ms-2" id="useLastBarcode">
                    <i class="fas fa-check me-1"></i> Usa
                </button>
            </div>
            {% endif %}
        </div>
        
        <!-- Tabella dipendenti in stile admin -->
        <div class="employees-table-container">
            <div class="table-toolbar">
                <h3 class="table-title">Elenco Ufficiali</h3>
                <div class="table-controls">
                    <div class="input-group table-search">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchEmployee" placeholder="Cerca utente...">
                    </div>
                    <button type="button" class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#newEmployeeModal">
                        <i class="fas fa-user-plus me-1"></i> Nuovo Operatore
                    </button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table class="employees-table" id="employeesTable">
                    <thead>
                        <tr>
                            <th>Utente</th>
                            <th>Codice</th>
                            <th>Credito</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in employees %}
                        {% if employee.code != 'CASSA' %}
                        <tr class="employee-row" data-employee-id="{{ employee.id }}" data-first-name="{{ employee.first_name }}" data-last-name="{{ employee.last_name }}">
                            <td class="employee-name-cell">
                                <div class="employee-avatar">{{ employee.first_name[0] }}{{ employee.last_name[0] }}</div>
                                <div class="employee-info">
                                    <div class="employee-name">{{ employee.first_name }} {{ employee.last_name }}</div>
                                    <div class="employee-rank">{{ employee.rank }}</div>
                                </div>
                            </td>
                            <td>
                                <span class="employee-code">{{ employee.code }}</span>
                            </td>
                            <td>
                                <div class="employee-credit">€ {{ "%.2f"|format(employee.credit) }}</div>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-sm btn-primary add-credit-btn" data-employee-id="{{ employee.id }}">
                                        <i class="fas fa-plus-circle"></i> Ricarica
                                    </button>
                                    <button class="btn btn-sm btn-success purchase-btn" data-employee-id="{{ employee.id }}">
                                        <i class="fas fa-shopping-cart"></i> Acquista
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Input manuale -->
    <div class="manual-input">
        <div class="input-group">
            <input type="text" id="manualBarcode" class="form-control form-control-lg" 
                   placeholder="Inserisci codice manualmente..." aria-label="Barcode">
            <button class="btn btn-primary" type="button" id="submitManualBarcode">
                <i class="fas fa-search me-1"></i> Cerca
            </button>
        </div>
    </div>
    
    <!-- Scheda dipendente (visualizzata dopo la scansione) -->
    <div class="employee-card" id="employeeCard">
        <div class="employee-card-header">
            <div class="employee-info">
                <div class="employee-avatar" id="employeeAvatar">AB</div>
                <div>
                    <div class="employee-name" id="employeeName">Nome</div>
                    <div class="employee-rank" id="employeeRank">Grado</div>
                </div>
            </div>
            <div class="employee-credit">
                <div class="credit-amount" id="creditAmount">€ 0.00</div>
                <div class="credit-label">Credito disponibile</div>
                <div class="credit-limit" id="creditLimit">Limite: € 0.00</div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between">
            <button class="btn btn-outline-light" id="cancelButton">
                <i class="fas fa-times me-1"></i> Annulla
            </button>
            <div>
                <button class="btn btn-light" id="addCreditButton">
                    <i class="fas fa-plus-circle me-1"></i> Ricarica
                </button>
                <button class="btn btn-success" id="deductCreditButton">
                    <i class="fas fa-shopping-cart me-1"></i> Acquista
                </button>
            </div>
        </div>
    </div>
    
    <!-- Selezione prodotti (visualizzata dopo aver cliccato "Acquista") -->
    <div class="product-selection" id="productSelection">
        <h4 class="mb-3">Seleziona Prodotto o Importo</h4>
        
        <!-- Ricerca prodotti -->
        <div class="mb-4">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="searchProductSale" placeholder="Cerca prodotto...">
                <button class="btn btn-outline-secondary" type="button" id="clearProductSearchBtn">
                    <i class="fas fa-times"></i> Pulisci
                </button>
            </div>
        </div>
        
        <div class="product-grid">
            {% for product in products %}
            <div class="product-item" data-product-id="{{ product.id }}" data-product-name="{{ product.name }}" data-product-price="{{ product.price }}">
                <div class="product-name">{{ product.name }}</div>
                <div class="product-price">€ {{ "%.2f"|format(product.price) }}</div>
                <div class="product-quantity mt-2">
                    <label for="quantity-{{ product.id }}" class="form-label small">Quantità</label>
                    <input type="number" class="form-control form-control-sm quantity-input" 
                           id="quantity-{{ product.id }}" min="1" value="1">
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="custom-amount-section">
            <h5 class="mb-3">Importo Personalizzato</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="customAmount" class="form-label">Importo (€)</label>
                    <input type="number" class="form-control" id="customAmount" step="0.01" min="0.01" placeholder="0.00">
                </div>
                <div class="col-md-6">
                    <label for="customProduct" class="form-label">Descrizione (opzionale)</label>
                    <input type="text" class="form-control" id="customProduct" placeholder="Prodotto personalizzato">
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-outline-secondary btn-lg" id="cancelProductButton">
                <i class="fas fa-arrow-left me-1"></i> Indietro
            </button>
            <button class="btn btn-success btn-lg" id="confirmProductButton">
                <i class="fas fa-check me-1"></i> Conferma
            </button>
        </div>
    </div>
    
    <!-- Form per aggiungere credito -->
    <div class="credit-form" id="creditForm">
        <h4 class="mb-3">Ricarica Credito</h4>
        
        <div class="mb-3">
            <label class="form-label">Importo da aggiungere</label>
            <div class="credit-presets">
                <div class="credit-preset" data-amount="5">€ 5.00</div>
                <div class="credit-preset" data-amount="10">€ 10.00</div>
                <div class="credit-preset" data-amount="20">€ 20.00</div>
                <div class="credit-preset" data-amount="50">€ 50.00</div>
                <div class="credit-preset" data-amount="100">€ 100.00</div>
            </div>
            
            <label for="customCreditAmount" class="form-label">O specifica un importo personalizzato</label>
            <input type="number" class="form-control" id="customCreditAmount" step="0.01" min="0.01" placeholder="0.00">
        </div>
        
        <div class="mb-3">
            <label for="operatorPassword" class="form-label">Password Operatore</label>
            <input type="password" class="form-control" id="operatorPassword" placeholder="Inserisci la password dell'operatore">
            <div class="form-text">È necessaria la password di un operatore per aggiungere credito</div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-outline-secondary btn-lg" id="cancelCreditButton">
                <i class="fas fa-arrow-left me-1"></i> Indietro
            </button>
            <button class="btn btn-success btn-lg" id="confirmCreditButton">
                <i class="fas fa-check me-1"></i> Conferma Ricarica
            </button>
        </div>
    </div>
    
    <!-- Modal di conferma acquisto -->
    <div class="modal fade" id="purchaseConfirmModal" tabindex="-1" aria-labelledby="purchaseConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="purchaseConfirmModalLabel">
                        <i class="fas fa-shopping-cart me-2"></i> Conferma Acquisto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Utente:</strong> <span id="confirmUserName"></span>
                    </div>
                    
                    <div class="table-responsive mb-3">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Prodotto</th>
                                    <th>Quantità</th>
                                    <th>Prezzo</th>
                                    <th>Totale</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseItemsList">
                                <!-- Popolato dinamicamente -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="text-end">Totale:</th>
                                    <th id="purchaseTotalAmount">€ 0.00</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Credito disponibile: <strong id="confirmAvailableCredit">€ 0.00</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-arrow-left me-1"></i> Modifica
                    </button>
                    <button type="button" class="btn btn-success" id="finalConfirmBtn">
                        <i class="fas fa-check me-1"></i> Conferma Acquisto
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Conferma operazione (mostrata dopo che l'operazione è completata) -->
    <div class="confirmation" id="confirmation">
        <i class="fas fa-check-circle confirmation-icon"></i>
        <h4 class="confirmation-title" id="confirmationTitle">Operazione Completata</h4>
        <p class="confirmation-message" id="confirmationMessage">Operazione effettuata con successo.</p>
        
        <div class="confirmation-details">
            <div class="confirmation-detail">
                <span class="confirmation-label">Utente:</span>
                <span class="confirmation-value" id="confirmationEmployee">-</span>
            </div>
            <div class="confirmation-detail">
                <span class="confirmation-label">Operazione:</span>
                <span class="confirmation-value" id="confirmationType">-</span>
            </div>
            <div class="confirmation-detail">
                <span class="confirmation-label">Importo:</span>
                <span class="confirmation-value" id="confirmationAmount">-</span>
            </div>
            <div class="confirmation-detail">
                <span class="confirmation-label">Nuovo credito:</span>
                <span class="confirmation-value" id="confirmationCredit">-</span>
            </div>
        </div>
        
        <button class="btn btn-primary btn-lg" id="newOperationButton">
            <i class="fas fa-redo me-1"></i> Nuova Operazione
        </button>
    </div>
</div>

<!-- Audio per effetti sonori -->
<audio id="purchaseSound" preload="auto">
    <source src="{{ url_for('static', filename='sounds/purchase.mp3') }}" type="audio/mpeg">
</audio>
<audio id="reloadSound" preload="auto">
    <source src="{{ url_for('static', filename='sounds/reload.mp3') }}" type="audio/mpeg">
</audio>
<audio id="errorSound" preload="auto">
    <source src="{{ url_for('static', filename='sounds/error.mp3') }}" type="audio/mpeg">
</audio>

<!-- Link amministratore -->
<a href="{{ url_for('admin_login') }}" class="admin-link">
    <i class="fas fa-cog me-1"></i> Amministrazione
</a>

<!-- Inventory Report Modal -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-boxes me-2"></i>
                    Resoconto Giacenze
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Search input -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="inventorySearch" placeholder="Cerca per nome articolo...">
                        <button class="btn btn-outline-secondary" type="button" id="clearInventorySearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome Articolo</th>
                                <th class="text-end">Giacenza</th>
                                <th class="text-end">Prezzo</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- Dati dinamici -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-primary" onclick="refreshInventory()">
                    <i class="fas fa-sync-alt me-1"></i> Aggiorna
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions Modal -->
<div class="modal fade" id="transactionsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i>
                    Ultime Transazioni
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Search and filters -->
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="transactionSearch" placeholder="Cerca per dipendente, prodotto...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="transactionTypeFilter">
                                <option value="">Tutti i tipi</option>
                                <option value="credit">Ricariche</option>
                                <option value="debit">Acquisti</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary" onclick="refreshTransactions()">
                                <i class="fas fa-sync-alt"></i> Aggiorna
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Data/Ora</th>
                                <th>Dipendente</th>
                                <th>Tipo</th>
                                <th>Importo</th>
                                <th>Prodotto</th>
                                <th>Quantità</th>
                                <th>Operatore</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Dati dinamici -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Transaction Confirmation Modal -->
<div class="modal fade" id="deleteTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash me-2"></i>
                    Elimina Transazione
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Attenzione!</strong> Stai per eliminare una transazione. Questa operazione:
                    <ul class="mb-0 mt-2">
                        <li>Ripristinerà il credito del dipendente</li>
                        <li>Ripristinerà l'inventario del prodotto (se applicabile)</li>
                        <li>Verrà registrata nei report amministratore</li>
                        <li><strong>Non può essere annullata</strong></li>
                    </ul>
                </div>
                
                <div id="transactionDetails" class="card mb-3">
                    <!-- Dettagli transazione -->
                </div>
                
                <div class="mb-3">
                    <label for="operatorPassword" class="form-label">Inserisci password operatore per confermare:</label>
                    <input type="password" class="form-control" id="operatorPassword" placeholder="Password operatore">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTransaction" onclick="confirmDeleteTransaction()">
                    <i class="fas fa-trash me-1"></i> Elimina Transazione
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal per Nuovo Operatore -->
<div class="modal fade" id="newEmployeeModal" tabindex="-1" aria-labelledby="newEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newEmployeeModalLabel">
                    <i class="fas fa-user-plus me-2"></i> Nuovo Operatore
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Attenzione:</strong> Per aggiungere un nuovo operatore è necessaria la password di un operatore autorizzato.
                </div>
                
                <form id="newEmployeeForm" action="{{ url_for('admin_new_employee') }}" method="POST">
                    <input type="hidden" name="redirect_to" value="barcode_scanner">
                    
                    <!-- Informazioni Personali -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-user me-2"></i> Informazioni Personali
                        </h6>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="new_first_name" class="form-label">Nome <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="new_first_name" name="first_name" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="new_last_name" class="form-label">Cognome <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="new_last_name" name="last_name" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="new_rank" class="form-label">Grado/Ruolo <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="new_rank" name="rank" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informazioni Codice -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-barcode me-2"></i> Codice Identificativo
                        </h6>
                        
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label for="new_code" class="form-label">Codice Badge <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="new_code" name="code" required placeholder="Inserisci o genera codice">
                                    <button class="btn btn-outline-secondary" type="button" id="generateNewCode">
                                        <i class="fas fa-random"></i> Genera
                                    </button>
                                </div>
                                <div class="form-text">
                                    Codice utilizzato per identificare l'operatore durante la scansione
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Impostazioni Credito -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-euro-sign me-2"></i> Impostazioni Credito
                        </h6>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="new_credit_limit" class="form-label">Limite di Credito Negativo</label>
                                <div class="input-group">
                                    <span class="input-group-text">€</span>
                                    <input type="number" class="form-control" id="new_credit_limit" name="credit_limit" value="0" min="0" step="0.01">
                                </div>
                                <div class="form-text">
                                    Massimo importo di credito negativo consentito (0 = nessun credito negativo)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Validazione Operatore -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-shield-alt me-2"></i> Validazione Operatore
                        </h6>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="new_operator_password" class="form-label">Password Operatore <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="new_operator_password" name="operator_password" required placeholder="Inserisci password operatore">
                                <div class="form-text">
                                    È necessaria la password di un operatore per aggiungere nuovi dipendenti
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Annulla
                </button>
                <button type="button" class="btn btn-success" id="saveNewEmployeeBtn">
                    <i class="fas fa-save me-1"></i> Salva Operatore
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Elementi DOM
    const scannerArea = document.getElementById('scannerArea');
    const scannerStatus = document.getElementById('scannerStatus');
    const manualBarcodeInput = document.getElementById('manualBarcode');
    const submitManualButton = document.getElementById('submitManualBarcode');
    const employeeCard = document.getElementById('employeeCard');
    const employeeAvatar = document.getElementById('employeeAvatar');
    const employeeName = document.getElementById('employeeName');
    const employeeRank = document.getElementById('employeeRank');
    const creditAmount = document.getElementById('creditAmount');
    const creditLimit = document.getElementById('creditLimit');
    const cancelButton = document.getElementById('cancelButton');
    const addCreditButton = document.getElementById('addCreditButton');
    const deductCreditButton = document.getElementById('deductCreditButton');
    const productSelection = document.getElementById('productSelection');
    const productItems = document.querySelectorAll('.product-item');
    const customAmountInput = document.getElementById('customAmount');
    const customProductInput = document.getElementById('customProduct');
    const cancelProductButton = document.getElementById('cancelProductButton');
    const confirmProductButton = document.getElementById('confirmProductButton');
    const creditForm = document.getElementById('creditForm');
    const creditPresets = document.querySelectorAll('.credit-preset');
    const customCreditInput = document.getElementById('customCreditAmount');
    const operatorPasswordInput = document.getElementById('operatorPassword');
    const cancelCreditButton = document.getElementById('cancelCreditButton');
    const confirmCreditButton = document.getElementById('confirmCreditButton');
    const confirmation = document.getElementById('confirmation');
    const confirmationTitle = document.getElementById('confirmationTitle');
    const confirmationMessage = document.getElementById('confirmationMessage');
    const confirmationEmployee = document.getElementById('confirmationEmployee');
    const confirmationType = document.getElementById('confirmationType');
    const confirmationAmount = document.getElementById('confirmationAmount');
    const confirmationCredit = document.getElementById('confirmationCredit');
    const newOperationButton = document.getElementById('newOperationButton');
    
    // Elementi audio
    const purchaseSound = document.getElementById('purchaseSound');
    const reloadSound = document.getElementById('reloadSound');
    const errorSound = document.getElementById('errorSound');
    
    // Elementi del modal di conferma acquisto
    const purchaseConfirmModal = new bootstrap.Modal(document.getElementById('purchaseConfirmModal'));
    const confirmUserName = document.getElementById('confirmUserName');
    const purchaseItemsList = document.getElementById('purchaseItemsList');
    const purchaseTotalAmount = document.getElementById('purchaseTotalAmount');
    const confirmAvailableCredit = document.getElementById('confirmAvailableCredit');
    const finalConfirmBtn = document.getElementById('finalConfirmBtn');
    
    // Variabili di stato dell'applicazione
    let currentEmployee = null;
    let selectedProduct = null;
    let selectedCreditAmount = null;
    let socket = null; // Connessione SocketIO
    let purchaseData = null; // Dati dell'acquisto corrente
    
    // Inizializza l'app al caricamento del documento
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
        setupEmployeeSearch();
        setupNewEmployeeModal();
        
        // Clean up modal backdrops when modals are hidden
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('hidden.bs.modal', function() {
                // Remove any leftover backdrops
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => {
                    if (backdrop.parentNode) {
                        backdrop.parentNode.removeChild(backdrop);
                    }
                });
                
                // Remove modal-open class from body if no modals are shown
                const openModals = document.querySelectorAll('.modal.show');
                if (openModals.length === 0) {
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            });
        });
    });
    
    // Aggiorna lo stato visivo dello scanner
    function updateScannerStatus(status) {
        scannerStatus.className = 'scanner-status';
        
        switch (status) {
            case 'connected':
                scannerStatus.classList.add('status-connected');
                scannerStatus.innerHTML = '<i class="fas fa-check-circle me-1"></i> Lettore connesso';
                break;
            case 'disconnected':
                scannerStatus.classList.add('status-disconnected');
                scannerStatus.innerHTML = '<i class="fas fa-times-circle me-1"></i> Lettore disconnesso';
                break;
            case 'waiting':
            default:
                scannerStatus.classList.add('status-waiting');
                scannerStatus.innerHTML = '<i class="fas fa-circle me-1"></i> In attesa di scansione...';
                break;
        }
    }
    
    // Inizializza l'app
    function initApp() {
        // Inizializza SocketIO
        initSocketIO();
        
        // Imposta lo stato dello scanner
        updateScannerStatus('waiting');
        
        // Focus sull'input manuale
        manualBarcodeInput.focus();
        
        // Gestisci il pulsante "Usa" per l'ultimo codice scansionato
        const useLastBarcodeButton = document.getElementById('useLastBarcode');
        if (useLastBarcodeButton) {
            useLastBarcodeButton.addEventListener('click', function() {
                const lastBarcode = document.getElementById('lastBarcode').textContent;
                processBarcode(lastBarcode);
            });
        }
        
        // Gestisci l'invio del codice manuale
        submitManualButton.addEventListener('click', function() {
            const barcode = manualBarcodeInput.value.trim();
            if (barcode) {
                processBarcode(barcode);
            }
        });
        
        // Gestisci l'invio con Enter
        manualBarcodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const barcode = this.value.trim();
                if (barcode) {
                    processBarcode(barcode);
                }
            }
        });
        
        // Gestisci i pulsanti della scheda dipendente
        cancelButton.addEventListener('click', resetApp);
        addCreditButton.addEventListener('click', showCreditForm);
        deductCreditButton.addEventListener('click', showProductSelection);
        
        // Gestisci la selezione prodotti
        productItems.forEach(item => {
            item.addEventListener('click', function() {
                // Alterna la selezione di questo prodotto
                this.classList.toggle('selected');
                
                // Pulisci l'importo personalizzato se è stato selezionato almeno un prodotto
                if (document.querySelectorAll('.product-item.selected').length > 0) {
                    customAmountInput.value = '';
                    customProductInput.value = '';
                }
            });
        });
        
        // Gestisci l'importo personalizzato
        customAmountInput.addEventListener('input', function() {
            if (this.value) {
                // Se si inserisce un importo personalizzato, deseleziona i prodotti
                productItems.forEach(p => p.classList.remove('selected'));
                selectedProduct = null;
            }
        });
        
        // Gestisci i pulsanti della selezione prodotti
        cancelProductButton.addEventListener('click', function() {
            // Torna alla scheda dipendente
            hideProductSelection();
            showEmployeeCard();
        });
        
        // Mostra il modal di conferma acquisto quando si clicca su Conferma
        confirmProductButton.addEventListener('click', showPurchaseConfirmation);
        
        // Gestisci il pulsante di conferma finale nel modal
        finalConfirmBtn.addEventListener('click', function() {
            // Chiudi il modal
            purchaseConfirmModal.hide();
            
            // Processa l'acquisto
            processDeduction();
        });
        
        // Supporto per la conferma con il tasto Enter nel modal
        document.getElementById('purchaseConfirmModal').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                // Simula il click sul pulsante di conferma
                finalConfirmBtn.click();
            }
        });
        
        // Gestisci i preset di ricarica credito
        creditPresets.forEach(preset => {
            preset.addEventListener('click', function() {
                // Rimuovi la selezione da tutti i preset
                creditPresets.forEach(p => p.classList.remove('selected'));
                // Seleziona questo preset
                this.classList.add('selected');
                // Salva l'importo selezionato
                selectedCreditAmount = parseFloat(this.dataset.amount);
                // Pulisci l'importo personalizzato
                customCreditInput.value = '';
            });
        });
        
        // Gestisci l'importo personalizzato per la ricarica
        customCreditInput.addEventListener('input', function() {
            if (this.value) {
                // Se si inserisce un importo personalizzato, deseleziona i preset
                creditPresets.forEach(p => p.classList.remove('selected'));
                selectedCreditAmount = null;
            }
        });
        
        // Gestisci i pulsanti del form di ricarica
        cancelCreditButton.addEventListener('click', function() {
            // Torna alla scheda dipendente
            hideCreditForm();
            showEmployeeCard();
        });
        
        confirmCreditButton.addEventListener('click', processAddCredit);
        
    // Gestisci il pulsante per una nuova operazione
    newOperationButton.addEventListener('click', resetApp);
    
    // Ricerca prodotti nella schermata di vendita
    const searchProductSale = document.getElementById('searchProductSale');
    const clearProductSearchBtn = document.getElementById('clearProductSearchBtn');
    const productItemsInSale = document.querySelectorAll('.product-item');
    
    // Funzione per filtrare i prodotti nella schermata di vendita
    function filterProductsInSale() {
        const searchTerm = searchProductSale.value.toLowerCase().trim();
        
        productItemsInSale.forEach(item => {
            const productName = item.querySelector('.product-name').textContent.toLowerCase().trim();
            
            if (searchTerm === '' || productName.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // Event listener per la ricerca prodotti nella vendita
    searchProductSale.addEventListener('input', filterProductsInSale);
    
    // Event listener per il pulsante di pulizia nella ricerca prodotti
    clearProductSearchBtn.addEventListener('click', function() {
        searchProductSale.value = '';
        filterProductsInSale();
        searchProductSale.focus();
    });
    
    // Funzione per resettare le quantità dei prodotti a 1
    function resetProductQuantities() {
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.value = 1;
        });
    }
    
    // Funzione per resettare la ricerca prodotti
    function resetProductSearch() {
        if (searchProductSale) {
            searchProductSale.value = '';
            filterProductsInSale();
        }
    }
    }
    
    // Inizializza SocketIO
    function initSocketIO() {
        console.log('🔧 Inizializzazione SocketIO...');
        showToast('🔧 Inizializzazione WebSocket...', 'info');
        
        // Connetti al server SocketIO
        socket = io();
        
        console.log('📡 Tentativo di connessione WebSocket...');
        
        // Gestisci la connessione
        socket.on('connect', function() {
            console.log('✅ Connesso al server WebSocket');
            console.log('Socket ID:', socket.id);
            showToast('✅ WebSocket connesso!', 'success');
            updateScannerStatus('connected');
            // Richiedi lo stato dello scanner
            console.log('📤 Richiesta stato scanner...');
            socket.emit('request_scanner_status');
        });
        
        // Gestisci la disconnessione
        socket.on('disconnect', function(reason) {
            console.log('❌ Disconnesso dal server WebSocket:', reason);
            showToast('❌ WebSocket disconnesso: ' + reason, 'warning');
            updateScannerStatus('disconnected');
        });
        
        // Gestisci errori di connessione
        socket.on('connect_error', function(error) {
            console.error('🚨 Errore connessione WebSocket:', error);
            showToast('🚨 Errore connessione WebSocket: ' + error.message, 'danger');
        });
        
        // Gestisci i barcode scansionati
        socket.on('barcode_scanned', function(data) {
            console.log('📷 Barcode ricevuto via WebSocket:', data);
            showToast('📷 Barcode ricevuto: ' + (data.barcode || 'N/A'), 'info');
            
            if (data.success) {
                console.log('✅ Dipendente trovato:', data.employee);
                showToast('✅ Dipendente: ' + data.employee.first_name + ' ' + data.employee.last_name, 'success');
                
                // Un codice è stato letto e un dipendente è stato trovato
                updateScannerStatus('connected');
                
                // Se non stiamo già visualizzando un dipendente, vai direttamente alla fase di acquisto
                if (!employeeCard.classList.contains('active') && productSelection.style.display !== 'block' && creditForm.style.display !== 'block') {
                    console.log('🛒 Vai alla schermata di acquisto...');
                    
                    // Salva i dati del dipendente
                    currentEmployee = data.employee;
                    
                    // Aggiorna la scheda del dipendente
                    employeeAvatar.textContent = (data.employee.first_name[0] + data.employee.last_name[0]).toUpperCase();
                    employeeName.textContent = `${data.employee.first_name} ${data.employee.last_name}`;
                    employeeRank.textContent = data.employee.rank;
                    creditAmount.textContent = `€ ${data.employee.credit.toFixed(2)}`;
                    creditLimit.textContent = `Limite: € ${data.employee.credit_limit.toFixed(2)}`;
                    
                    // Vai direttamente alla schermata di acquisto
                    hideScannerArea();
                    showProductSelection();
                } else {
                    console.log('⚠️ Schermata già attiva, ignorando barcode');
                }
            } else if (data.barcode) {
                console.log('❌ Dipendente non trovato per barcode:', data.barcode);
                showToast('❌ Dipendente non trovato per: ' + data.barcode, 'warning');
                
                // Un codice è stato letto ma non è stato trovato un dipendente
                updateScannerStatus('connected');
                
                // Mostra un messaggio solo se non stiamo già visualizzando un dipendente
                if (!employeeCard.classList.contains('active')) {
                    showToast(`Codice letto (${data.barcode}) ma utente non trovato.`, 'warning');
                }
            }
        });
        
        // Gestisci gli errori dello scanner
        socket.on('scanner_error', function(data) {
            console.error('🚨 Errore scanner:', data.error);
            showToast('🚨 Errore scanner: ' + data.error, 'danger');
            updateScannerStatus('disconnected');
        });
        
        // Gestisci lo stato dello scanner
        socket.on('scanner_status', function(data) {
            console.log('📊 Stato scanner ricevuto:', data);
            showToast('📊 Stato scanner aggiornato', 'info');
            updateScannerStatus(data.connected ? 'connected' : 'waiting');
        });
        
        // Gestisci eventi generici
        socket.on('connected', function(data) {
            console.log('🎉 Messaggio di benvenuto:', data);
            showToast('🎉 ' + data.data, 'success');
        });
        
        // Debug generale per tutti gli eventi
        socket.onAny((event, ...args) => {
            console.log('🔍 Evento WebSocket ricevuto:', event, args);
        });
        
        // Timeout per verificare la connessione
        setTimeout(() => {
            if (!socket.connected) {
                console.error('⏰ Timeout connessione WebSocket');
                showToast('⏰ Timeout connessione WebSocket', 'danger');
            } else {
                console.log('⏰ Connessione WebSocket verificata dopo 3 secondi');
                showToast('⏰ WebSocket verificato!', 'success');
            }
        }, 3000);
    }
    
    // Processa un codice a barre (manuale o scansionato)
    function processBarcode(barcode) {
        fetch("{{ url_for('scan_barcode') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `barcode=${encodeURIComponent(barcode)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                processEmployeeData(data.employee);
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error("Errore:", error);
            showToast("Errore durante la ricerca del utente.", 'danger');
        });
    }
    
    // Processa i dati del dipendente e vai direttamente alla fase di acquisto
    function processEmployeeData(employee) {
        // Salva i dati del dipendente
        currentEmployee = employee;
        
        // Aggiorna la scheda del dipendente
        employeeAvatar.textContent = (employee.first_name[0] + employee.last_name[0]).toUpperCase();
        employeeName.textContent = `${employee.first_name} ${employee.last_name}`;
        employeeRank.textContent = employee.rank;
        creditAmount.textContent = `€ ${employee.credit.toFixed(2)}`;
        creditLimit.textContent = `Limite: € ${employee.credit_limit.toFixed(2)}`;
        
        // Nascondi lo scanner e vai direttamente alla schermata di acquisto
        hideScannerArea();
        showProductSelection();
        
        // Pulisci l'input manuale
        manualBarcodeInput.value = '';
    }
    
    // Mostra il modal di conferma acquisto
    function showPurchaseConfirmation() {
        if (!currentEmployee) {
            showToast('Nessun utente selezionato.', 'danger');
            return;
        }
        
        // Ottieni tutti i prodotti selezionati con le loro quantità
        const selectedProducts = [];
        let totalAmount = 0;
        
        // Raccogli i prodotti selezionati
        document.querySelectorAll('.product-item.selected').forEach(item => {
            const productId = item.dataset.productId;
            const productName = item.dataset.productName;
            const productPrice = parseFloat(item.dataset.productPrice);
            const quantityInput = item.querySelector('.quantity-input');
            const quantity = parseInt(quantityInput.value) || 1;
            
            if (quantity > 0) {
                selectedProducts.push({
                    id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: quantity
                });
                
                totalAmount += productPrice * quantity;
            }
        });
        
        // Controlla se è stato inserito un importo personalizzato
        let customAmount = null;
        let customProduct = null;
        
        if (customAmountInput.value) {
            customAmount = parseFloat(customAmountInput.value);
            customProduct = customProductInput.value || 'Importo personalizzato';
            totalAmount = customAmount;
            
            // Aggiungi l'importo personalizzato come prodotto
            selectedProducts.push({
                id: null,
                name: customProduct,
                price: customAmount,
                quantity: 1
            });
        }
        
        // Verifica che sia stato selezionato almeno un prodotto o inserito un importo
        if (selectedProducts.length === 0) {
            showToast('Seleziona almeno un prodotto o inserisci un importo personalizzato.', 'warning');
            return;
        }
        
        // Salva i dati dell'acquisto per il processamento successivo
        purchaseData = {
            selectedProducts: selectedProducts,
            totalAmount: totalAmount
        };
        
        // Aggiorna il modal con i dati dell'acquisto
        confirmUserName.textContent = `${currentEmployee.first_name} ${currentEmployee.last_name}`;
        confirmAvailableCredit.textContent = `€ ${currentEmployee.credit.toFixed(2)}`;
        purchaseTotalAmount.textContent = `€ ${totalAmount.toFixed(2)}`;
        
        // Popola la tabella dei prodotti
        purchaseItemsList.innerHTML = '';
        selectedProducts.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.quantity}</td>
                <td>€ ${product.price.toFixed(2)}</td>
                <td>€ ${(product.price * product.quantity).toFixed(2)}</td>
            `;
            purchaseItemsList.appendChild(row);
        });
        
        // Mostra il modal
        purchaseConfirmModal.show();
        
        // Focus sul pulsante di conferma per supportare la pressione di Enter
        setTimeout(() => {
            finalConfirmBtn.focus();
        }, 500);
    }
    
    // Elabora la richiesta di deduzione di credito
    function processDeduction() {
        if (!currentEmployee) {
            showToast('Nessun utente selezionato.', 'danger');
            return;
        }
        
        // Ottieni tutti i prodotti selezionati con le loro quantità
        const selectedProducts = [];
        let totalAmount = 0;
        let productDescription = '';
        
        // Raccogli i prodotti selezionati
        document.querySelectorAll('.product-item.selected').forEach(item => {
            const productId = item.dataset.productId;
            const productName = item.dataset.productName;
            const productPrice = parseFloat(item.dataset.productPrice);
            const quantityInput = item.querySelector('.quantity-input');
            const quantity = parseInt(quantityInput.value) || 1;
            
            if (quantity > 0) {
                selectedProducts.push({
                    id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: quantity
                });
                
                totalAmount += productPrice * quantity;
                
                // Aggiungi alla descrizione
                if (productDescription) {
                    productDescription += ', ';
                }
                productDescription += `${productName} (${quantity})`;
            }
        });
        
        // Controlla se è stato inserito un importo personalizzato
        let customAmount = null;
        let customProduct = null;
        
        if (customAmountInput.value) {
            customAmount = parseFloat(customAmountInput.value);
            customProduct = customProductInput.value || 'Importo personalizzato';
            totalAmount = customAmount;
            productDescription = customProduct;
        }
        
        // Verifica che sia stato selezionato almeno un prodotto o inserito un importo
        if (selectedProducts.length === 0 && !customAmount) {
            showToast('Seleziona almeno un prodotto o inserisci un importo personalizzato.', 'warning');
            return;
        }
        
        // Prepara i dati per la richiesta
        const formData = new FormData();
        formData.append('employee_id', currentEmployee.id);
        
        if (selectedProducts.length > 0) {
            // Invia i prodotti selezionati come JSON
            formData.append('products', JSON.stringify(selectedProducts));
        } else {
            // Invia l'importo personalizzato
            formData.append('custom_amount', customAmount);
            formData.append('custom_product', customProduct);
        }
        
        // Invia la richiesta
        fetch("{{ url_for('deduct_credit') }}", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Aggiorna il credito del dipendente
                currentEmployee.credit = data.new_credit;
                
                // Riproduci il suono di acquisto
                purchaseSound.play();
                
                // Mostra la conferma
                showConfirmation(
                    'Acquisto Completato',
                    data.message,
                    `${currentEmployee.first_name} ${currentEmployee.last_name}`,
                    productDescription,
                    `-€ ${totalAmount.toFixed(2)}`,
                    `€ ${data.new_credit.toFixed(2)}`
                );
            } else {
                // Riproduci il suono di errore
                errorSound.play();
                
                showToast(data.message, 'danger');
               }
        })
        .catch(error => {
            console.error("Errore:", error);
            showToast('Errore durante l\'elaborazione dell\'acquisto.', 'danger');
        });
    }
    
    // Elabora la richiesta di aggiunta credito
    function processAddCredit() {
        if (!currentEmployee) {
            showToast('Nessun utente selezionato.', 'danger');
            return;
        }
        
        // Determina l'importo da aggiungere
        let amount = selectedCreditAmount;
        if (!amount && customCreditInput.value) {
            amount = parseFloat(customCreditInput.value);
        }
        
        if (!amount || amount <= 0) {
            showToast('Inserisci un importo valido per la ricarica.', 'warning');
            return;
        }
        
        // Ottieni la password dell'operatore
        const operatorPassword = operatorPasswordInput.value;
        if (!operatorPassword) {
            showToast('Inserisci la password dell\'operatore.', 'warning');
            return;
        }
        
        // Prepara i dati per la richiesta
        const formData = new FormData();
        formData.append('employee_id', currentEmployee.id);
        formData.append('amount', amount);
        formData.append('operator_password', operatorPassword);
        
        // Invia la richiesta
        fetch("{{ url_for('add_credit') }}", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Aggiorna il credito del dipendente
                currentEmployee.credit = data.new_credit;
                
                // Riproduci il suono di ricarica
                reloadSound.play();
                
                // Mostra la conferma
                showConfirmation(
                    'Ricarica Completata',
                    data.message,
                    `${currentEmployee.first_name} ${currentEmployee.last_name}`,
                    'Ricarica credito',
                    `+€ ${amount.toFixed(2)}`,
                    `€ ${data.new_credit.toFixed(2)}`
                );
            } else {
                // Riproduci il suono di errore
                errorSound.play();
                
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error("Errore:", error);
            showToast('Errore durante l\'elaborazione della ricarica.', 'danger');
        });
    }
    
    // Mostra la schermata di conferma
    function showConfirmation(title, message, employee, type, amount, newCredit) {
        // Nascondi tutte le altre viste
        hideAll();
        
        // Aggiorna i dati di conferma
        confirmationTitle.textContent = title;
        confirmationMessage.textContent = message;
        confirmationEmployee.textContent = employee;
        confirmationType.textContent = type;
        confirmationAmount.textContent = amount;
        confirmationCredit.textContent = newCredit;
        
        // Mostra la conferma
        confirmation.style.display = 'block';
        
        // Riconnetti automaticamente dopo un po'
        setTimeout(() => {
            if (socket && !socket.connected) {
                socket.connect();
            }
        }, 5000);
    }
    
    // Funzioni di gestione della visibilità dei componenti
    function hideAll() {
        hideScannerArea();
        hideEmployeeCard();
        hideProductSelection();
        hideCreditForm();
        hideConfirmation();
    }
    
    function showScannerArea() {
        scannerArea.style.display = 'flex';
        manualBarcodeInput.focus();
    }
    
    function hideScannerArea() {
        scannerArea.style.display = 'none';
    }
    
    function showEmployeeCard() {
        employeeCard.style.display = 'block';
        employeeCard.classList.add('active');
    }
    
    function hideEmployeeCard() {
        employeeCard.style.display = 'none';
        employeeCard.classList.remove('active');
    }
    
    function showProductSelection() {
        hideEmployeeCard();
        productSelection.style.display = 'block';
        
        // Reset della selezione
        productItems.forEach(p => p.classList.remove('selected'));
        selectedProduct = null;
        customAmountInput.value = '';
        customProductInput.value = '';
        
        // Reset delle quantità a 1
        resetProductQuantities();
    }
    
    function hideProductSelection() {
        productSelection.style.display = 'none';
    }
    
    function showCreditForm() {
        hideEmployeeCard();
        creditForm.style.display = 'block';
        
        // Reset della selezione
        creditPresets.forEach(p => p.classList.remove('selected'));
        selectedCreditAmount = null;
        customCreditInput.value = '';
        operatorPasswordInput.value = '';
    }
    
    function hideCreditForm() {
        creditForm.style.display = 'none';
    }
    
    function hideConfirmation() {
        confirmation.style.display = 'none';
    }
    
    // Resetta l'app allo stato iniziale
    function resetApp() {
        // Reset delle variabili
        currentEmployee = null;
        selectedProduct = null;
        selectedCreditAmount = null;
        purchaseData = null;
        
        // Reset degli input
        manualBarcodeInput.value = '';
        customAmountInput.value = '';
        customProductInput.value = '';
        customCreditInput.value = '';
        operatorPasswordInput.value = '';
        
        // Reset delle selezioni
        productItems.forEach(p => p.classList.remove('selected'));
        creditPresets.forEach(p => p.classList.remove('selected'));
        
        // Reset delle quantità a 1
        resetProductQuantities();
        
        // Reset della ricerca prodotti
        resetProductSearch();
        
        // Mostra lo scanner e nasconde tutto il resto
        hideAll();
        showScannerArea();
    }
    
    // Funzione per mostrare i toast
    function showToast(message, type = 'info') {
        // Crea un elemento toast se non esiste
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
            toastContainer.style.zIndex = 1050;
            document.body.appendChild(toastContainer);
        }
        
        // Crea il toast
        const toastId = 'toast-' + Date.now();
        const toastElement = document.createElement('div');
        toastElement.id = toastId;
        toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
        toastElement.role = 'alert';
        toastElement.setAttribute('aria-live', 'assertive');
        toastElement.setAttribute('aria-atomic', 'true');
        
        // Imposta il contenuto del toast
        toastElement.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Aggiungi il toast al container
        toastContainer.appendChild(toastElement);
        
        // Inizializza il toast con Bootstrap
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 5000
        });
        
        // Mostra il toast
        toast.show();
        
        // Rimuovi il toast dal DOM quando è stato nascosto
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    // Funzione di ricerca per la tabella dipendenti
    function setupEmployeeSearch() {
        const searchEmployee = document.getElementById('searchEmployee');
        const employeeRows = document.querySelectorAll('.employee-row');
        
        // Funzione per filtrare le righe
        function filterRows() {
            const searchTerm = searchEmployee.value.toLowerCase();
            
            employeeRows.forEach(row => {
                const firstName = row.dataset.firstName.toLowerCase();
                const lastName = row.dataset.lastName.toLowerCase();
                const fullName = `${firstName} ${lastName}`.toLowerCase();
                const reverseName = `${lastName} ${firstName}`.toLowerCase();
                
                // Mostra la riga se il termine di ricerca è contenuto nel nome, cognome o in entrambi
                if (firstName.includes(searchTerm) || 
                    lastName.includes(searchTerm) || 
                    fullName.includes(searchTerm) || 
                    reverseName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Aggiungi event listener per l'input di ricerca
        searchEmployee.addEventListener('input', filterRows);
        
        // Gestisci i pulsanti di ricarica e acquisto nella tabella
        document.querySelectorAll('.add-credit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const employeeId = this.dataset.employeeId;
                
                // Ottieni i dati del dipendente e vai direttamente alla ricarica
                fetch("{{ url_for('scan_barcode') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: new URLSearchParams({
                        'employee_id': employeeId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        processEmployeeData(data.employee);
                        // Vai direttamente alla schermata di ricarica
                        hideScannerArea();
                        showCreditForm();
                    } else {
                        showToast(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error("Errore:", error);
                    showToast("Errore durante la selezione dell'utente.", 'danger');
                });
            });
        });
        
        document.querySelectorAll('.purchase-btn').forEach(button => {
            button.addEventListener('click', function() {
                const employeeId = this.dataset.employeeId;
                
                // Ottieni i dati del dipendente e vai direttamente all'acquisto
                fetch("{{ url_for('scan_barcode') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: new URLSearchParams({
                        'employee_id': employeeId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        processEmployeeData(data.employee);
                        // Vai direttamente alla schermata di acquisto
                        hideScannerArea();
                        showProductSelection();
                    } else {
                        showToast(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error("Errore:", error);
                    showToast("Errore durante la selezione dell'utente.", 'danger');
                });
            });
        });
    }
    
    // Gestione del modal per nuovo operatore
    function setupNewEmployeeModal() {
        const newEmployeeModal = new bootstrap.Modal(document.getElementById('newEmployeeModal'));
        const newEmployeeForm = document.getElementById('newEmployeeForm');
        const saveNewEmployeeBtn = document.getElementById('saveNewEmployeeBtn');
        const generateNewCodeBtn = document.getElementById('generateNewCode');
        const newCodeInput = document.getElementById('new_code');
        
        // Gestione generazione codice automatico
        if (generateNewCodeBtn && newCodeInput) {
            generateNewCodeBtn.addEventListener('click', function() {
                // Genera un codice alfanumerico di 8 caratteri
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code = '';
                for (let i = 0; i < 8; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                newCodeInput.value = code;
            });
        }
        
        // Gestione del pulsante salva
        if (saveNewEmployeeBtn && newEmployeeForm) {
            saveNewEmployeeBtn.addEventListener('click', function() {
                // Validazione campi obbligatori
                const firstName = document.getElementById('new_first_name').value.trim();
                const lastName = document.getElementById('new_last_name').value.trim();
                const rank = document.getElementById('new_rank').value.trim();
                const code = document.getElementById('new_code').value.trim();
                const operatorPassword = document.getElementById('new_operator_password').value.trim();
                
                if (!firstName || !lastName || !rank || !code || !operatorPassword) {
                    showToast('Tutti i campi obbligatori devono essere compilati', 'danger');
                    return;
                }
                
                if (code.length === 0) {
                    showToast('Inserisci un codice valido', 'danger');
                    return;
                }
                
                if (!operatorPassword) {
                    showToast('Inserisci la password operatore', 'danger');
                    return;
                }
                
                // Validazione form nativa
                if (newEmployeeForm.checkValidity()) {
                    // Disabilita il pulsante durante l'invio
                    saveNewEmployeeBtn.disabled = true;
                    saveNewEmployeeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Salvataggio...';
                    
                    // Invia il form
                    newEmployeeForm.submit();
                } else {
                    // Trigger validazione nativa del browser
                    newEmployeeForm.reportValidity();
                }
            });
        }
        
        // Reset del form quando il modal viene chiuso
        document.getElementById('newEmployeeModal').addEventListener('hidden.bs.modal', function() {
            if (newEmployeeForm) {
                newEmployeeForm.reset();
                // Pulisci manualmente i campi che potrebbero non essere resettati automaticamente
                document.getElementById('new_first_name').value = '';
                document.getElementById('new_last_name').value = '';
                document.getElementById('new_rank').value = '';
                document.getElementById('new_code').value = '';
                document.getElementById('new_credit_limit').value = '0';
                document.getElementById('new_operator_password').value = '';
            }
            
            // Riabilita il pulsante salva
            if (saveNewEmployeeBtn) {
                saveNewEmployeeBtn.disabled = false;
                saveNewEmployeeBtn.innerHTML = '<i class="fas fa-save me-1"></i> Salva Operatore';
            }
        });
        
        // Focus automatico sul primo campo quando si apre il modal
        document.getElementById('newEmployeeModal').addEventListener('shown.bs.modal', function() {
            const operatorPasswordInput = document.getElementById('new_operator_password');
            if (operatorPasswordInput) {
                operatorPasswordInput.focus();
            }
        });
    }
    
    // Inventory functionality
    function showInventoryReport() {
        fetch('/api/products')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateInventoryTable(data.products);
                    const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
                    modal.show();
                } else {
                    showToast('Errore nel caricamento delle giacenze', 'danger');
                }
            })
            .catch(error => {
                console.error('Error loading inventory:', error);
                showToast('Errore di rete nel caricamento delle giacenze', 'danger');
            });
    }

    function populateInventoryTable(products) {
        const tbody = document.getElementById('inventoryTableBody');
        tbody.innerHTML = '';
        
        products.forEach(product => {
            const row = document.createElement('tr');
            
            // Color coding based on inventory level
            let inventoryClass = '';
            let badgeClass = 'bg-success';
            if (product.inventory <= 0) {
                badgeClass = 'bg-danger';
            } else if (product.inventory <= 5) {
                badgeClass = 'bg-warning';
            }
            
            row.innerHTML = `
                <td>${product.id}</td>
                <td>${product.name}</td>
                <td class="text-end">
                    <span class="badge ${badgeClass}">${product.inventory}</span>
                </td>
                <td class="text-end">€${product.price.toFixed(2)}</td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function refreshInventory() {
        // Ricarica solo i dati senza creare un nuovo modal
        fetch('/api/products')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateInventoryTable(data.products);
                } else {
                    showToast('Errore nel caricamento delle giacenze', 'danger');
                }
            })
            .catch(error => {
                console.error('Error refreshing inventory:', error);
                showToast('Errore di rete nel caricamento delle giacenze', 'danger');
            });
    }

    function filterInventoryTable() {
        const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
        const tableRows = document.querySelectorAll('#inventoryTableBody tr');
        
        tableRows.forEach(row => {
            const productName = row.cells[1].textContent.toLowerCase();
            const productId = row.cells[0].textContent.toLowerCase();
            
            if (productName.includes(searchTerm) || productId.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Initialize inventory search when modal is shown
    document.getElementById('inventoryModal').addEventListener('shown.bs.modal', function () {
        // Add event listeners for search
        const searchInput = document.getElementById('inventorySearch');
        const clearButton = document.getElementById('clearInventorySearch');
        
        searchInput.addEventListener('input', filterInventoryTable);
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            filterInventoryTable();
            searchInput.focus();
        });
        
        // Clear search when modal opens
        searchInput.value = '';
    });

    // Transactions functionality (same as products_first.html)
    let transactionToDelete = null;

    function showRecentTransactions() {
        fetch('/api/recent_transactions')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateTransactionsTable(data.transactions);
                    const modal = new bootstrap.Modal(document.getElementById('transactionsModal'));
                    modal.show();
                } else {
                    showToast('Errore nel caricamento delle transazioni', 'danger');
                }
            })
            .catch(error => {
                console.error('Error loading transactions:', error);
                showToast('Errore di rete nel caricamento delle transazioni', 'danger');
            });
    }

    function populateTransactionsTable(transactions) {
        const tbody = document.getElementById('transactionsTableBody');
        tbody.innerHTML = '';
        
        transactions.forEach(transaction => {
            const row = document.createElement('tr');
            
            // Format timestamp
            const date = new Date(transaction.timestamp);
            const formattedDate = date.toLocaleString('it-IT');
            
            // Transaction type badge
            const typeBadge = transaction.transaction_type === 'credit' 
                ? '<span class="badge bg-success">Ricarica</span>'
                : '<span class="badge bg-danger">Acquisto</span>';
            
            // Amount with sign
            const amount = transaction.transaction_type === 'credit'
                ? `+€${Math.abs(transaction.amount).toFixed(2)}`
                : `-€${Math.abs(transaction.amount).toFixed(2)}`;
            
            // Product info
            const productInfo = transaction.product_name || transaction.custom_product_name || '-';
            const quantity = transaction.quantity || '-';
            
            // Operator info
            const operatorInfo = transaction.operator_name || 'Sistema';
            
            row.innerHTML = `
                <td class="text-nowrap">${formattedDate}</td>
                <td>${transaction.employee_name}</td>
                <td>${typeBadge}</td>
                <td class="${transaction.transaction_type === 'credit' ? 'text-success' : 'text-danger'}">${amount}</td>
                <td>${productInfo}</td>
                <td>${quantity}</td>
                <td>${operatorInfo}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="prepareDeleteTransaction(${transaction.id})" 
                            title="Elimina transazione">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Add search and filter event listeners
        initializeTransactionFilters();
    }

    function initializeTransactionFilters() {
        const searchInput = document.getElementById('transactionSearch');
        const typeFilter = document.getElementById('transactionTypeFilter');
        
        if (searchInput) searchInput.addEventListener('input', filterTransactions);
        if (typeFilter) typeFilter.addEventListener('change', filterTransactions);
    }

    function filterTransactions() {
        const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
        const typeFilter = document.getElementById('transactionTypeFilter').value;
        const rows = document.querySelectorAll('#transactionsTableBody tr');
        
        rows.forEach(row => {
            const employee = row.cells[1].textContent.toLowerCase();
            const product = row.cells[4].textContent.toLowerCase();
            const operator = row.cells[6].textContent.toLowerCase();
            const type = row.cells[2].textContent.includes('Ricarica') ? 'credit' : 'debit';
            
            const matchesSearch = employee.includes(searchTerm) || 
                                product.includes(searchTerm) || 
                                operator.includes(searchTerm);
            const matchesType = !typeFilter || type === typeFilter;
            
            row.style.display = (matchesSearch && matchesType) ? '' : 'none';
        });
    }

    function refreshTransactions() {
        showRecentTransactions();
    }

    function prepareDeleteTransaction(transactionId) {
        // Get transaction details
        fetch(`/api/transaction/${transactionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    transactionToDelete = data.transaction;
                    showDeleteTransactionModal(data.transaction);
                } else {
                    showToast('Errore nel caricamento dei dettagli della transazione', 'danger');
                }
            })
            .catch(error => {
                console.error('Error loading transaction details:', error);
                showToast('Errore di rete', 'danger');
            });
    }

    function showDeleteTransactionModal(transaction) {
        const detailsDiv = document.getElementById('transactionDetails');
        
        const date = new Date(transaction.timestamp);
        const formattedDate = date.toLocaleString('it-IT');
        
        const typeBadge = transaction.transaction_type === 'credit' 
            ? '<span class="badge bg-success">Ricarica</span>'
            : '<span class="badge bg-danger">Acquisto</span>';
        
        const amount = transaction.transaction_type === 'credit'
            ? `+€${Math.abs(transaction.amount).toFixed(2)}`
            : `-€${Math.abs(transaction.amount).toFixed(2)}`;
        
        const productInfo = transaction.product_name || transaction.custom_product_name || 'Nessun prodotto';
        
        detailsDiv.innerHTML = `
            <div class="card-body">
                <h6 class="card-title">Dettagli Transazione</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Data/Ora:</strong> ${formattedDate}<br>
                        <strong>Dipendente:</strong> ${transaction.employee_name}<br>
                        <strong>Tipo:</strong> ${typeBadge}
                    </div>
                    <div class="col-md-6">
                        <strong>Importo:</strong> <span class="${transaction.transaction_type === 'credit' ? 'text-success' : 'text-danger'}">${amount}</span><br>
                        <strong>Prodotto:</strong> ${productInfo}<br>
                        <strong>Quantità:</strong> ${transaction.quantity || '-'}
                    </div>
                </div>
            </div>
        `;
        
        // Clear password field
        document.getElementById('operatorPassword').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('deleteTransactionModal'));
        modal.show();
    }

    function confirmDeleteTransaction() {
        const password = document.getElementById('operatorPassword').value;
        
        if (!password) {
            showToast('Inserisci la password operatore', 'danger');
            return;
        }
        
        if (!transactionToDelete) {
            showToast('Nessuna transazione selezionata', 'danger');
            return;
        }
        
        // Send delete request with password
        fetch(`/api/delete_transaction/${transactionToDelete.id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                operator_password: password
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close delete modal
                bootstrap.Modal.getInstance(document.getElementById('deleteTransactionModal')).hide();
                
                // Show success message
                showToast('Transazione eliminata con successo', 'success');
                
                // Refresh transactions list
                refreshTransactions();
                
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting transaction:', error);
            showToast('Errore di comunicazione con il server', 'danger');
        });
    }
</script>
{% endblock %}
